name: Build and Deploy to Cloudflare Pages

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prepare NoCloud datasource
        run: |
          mkdir output

          # Create empty meta-data file
          touch output/meta-data

          # Rename autoinstall template â†’ user-data
          cp autoinstall.yaml output/user-data

          # 1. Convert NAME to lowercase
          LOWER_USERNAME=$(echo "${{ vars.NAME }}" | tr '[:upper:]' '[:lower:]')

          # 2. Create SHA-512 hashed password (cloud-init compatible)
          PASSWORD_HASH=$(python3 - <<EOF
          import crypt, sys
          print(crypt.crypt("${{ secrets.PASSWORD }}", crypt.mksalt(crypt.METHOD_SHA512)))
          EOF
          )

          # 3. Substitute into user-data
          sed -i "s|\${REALNAME}|${{ vars.NAME }}|g" output/user-data
          sed -i "s|\${USERNAME}|$LOWER_USERNAME|g" output/user-data
          sed -i "s|\${PASSWORD_HASH}|$PASSWORD_HASH|g" output/user-data

      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          projectName: "ubuntu-autoinstall"
          directory: "./output"
